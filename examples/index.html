<!DOCTYPE html><head>
<title>LittleJS Example Browser</title>
<link rel=icon type=image/png href=favicon.png>
<meta charset=utf-8>
<style>
html, body
{
    height: 100%;
    display: flex;
    flex-direction: column;
}
#container1
{
    height: 100%;
    display: flex;
    gap: 4px;
}
#container2
{
    display: flex;
    flex-direction: column;
    gap: 4px;
}
#iframeContainer
{
    border: 2px solid;
    background: #000;
}
iframe
{
    width: 100%;
    height: 100%;
    border: none;
}
#selectExample
{
    flex-grow: 1;
}
#textareaCode
{
    flex-grow: 1;
    padding: 5px;
    resize: none;
    color: #fff;
    background: #000;
    font-size: 20px;
}
#textareaError
{
    flex-grow: .3;
    padding: 5px;
    resize: none;
    display: none;
    color:#f22;
    background: #111;
}
#container3
{
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 2px;
}
#titleInfo
{
    margin: 5px;
    text-align: center;
    font-size: 40px;
}
#exampleInfo
{
    margin: 0px;
    text-align: center;
    font-size: 20px;
}
#exampleLink
{
    margin: 0px;
    text-align: center;
    font-size: 20px;
    display: inline-block;
    align-self: center;
}
select
{
    color:#fff;
    background-color: #111;
    width:100%;
}
hr
{
    border: 1px solid #555;
    margin:9px;
}
</style>
</head><body>
<div id=container1>
<div id=container3>
<p id=titleInfo>LittleJS Example Browser</p>
<p id=exampleInfo></p>
<a id=exampleLink target='_blank'></a>
<hr>
<div>
Theme:
<select style=width:120px onchange=loadTheme() id=selectTheme></select>
<select style=width:40px onchange=loadTheme() id=selectFontSize>
    <option value=10px>XS</option>
    <option value=13px>S</option>
    <option value=16px selected>M</option>
    <option value=20px>L</option>
    <option value=24px>XL</option>
</select>
<input type=checkbox id=checkboxLiveEdit checked>Live Edit
</div> 
<textarea id=textareaCode oninput=codeInput() spellcheck=false></textarea>
<textarea id=textareaError readonly spellcheck=false></textarea>

</div>
<div id=container2>
<div id=iframeContainer></div>
<div>
<input id=inputSearch placeholder='Search examples...' oninput=filterExamples() onkeydown='if(event.key=="Escape")filterExamples(1)'> 
<button onclick=filterExamples(1)>Clear</button>
<button id=buttonScreenshot>Screenshot</button>
</div>
<select id=selectExample autofocus onchange=setExample() size=2></select>
</div>
</div>
<script>
'use strict';

class ExampleInfo
{
    constructor(name, filename, description='', largeExample=false)
    {
        if (filename && !largeExample)
            filename = 'shorts/' + filename; // short examples folder
        this.name = name;
        this.filename = filename;
        this.description = description;
        this.largeExample = largeExample;
    }
}

const exampleList = 
[
    new ExampleInfo('--- SHORT EXAMPLES ---'),
    new ExampleInfo('Hello World', 'helloWorld.js', 'Simplest example'),
    new ExampleInfo('Shapes', 'shapes.js', 'How to draw geometric shapes'),
    new ExampleInfo('Colors', 'colors.js', 'How to use the color object'),
    new ExampleInfo('Blending', 'blending.js', 'How to use blending modes'),
    new ExampleInfo('Timers', 'timers.js', 'How to use the timer object'),
    new ExampleInfo('Texture', 'texture.js', 'How to display a full texture'),
    new ExampleInfo('Particles', 'particles.js', 'How to use the particle system'),
    new ExampleInfo('Play Sound', 'playSound.js', 'How to play sounds with zzfx'),
    new ExampleInfo('System Font', 'systemFont.js', 'Demo of the included system font'),
    new ExampleInfo('Sprite Atlas', 'spriteAtlas.js', 'How to set up a simple sprite atlas'),
    new ExampleInfo('Animation', 'animation.js', 'How to animate sprites'),
    new ExampleInfo('Clock', 'clock.js', 'Simple clock showing the time'),
    new ExampleInfo('Tile Layer', 'tileLayer.js', 'How to use the tile layer object'),
    new ExampleInfo('Piano', 'piano.js', 'A simple piano keyboard demo'),
    new ExampleInfo('Maze Generator', 'maze.js', 'Generates a random maze'),
    new ExampleInfo('Box2d Demo', 'box2d.js', 'Demo of the Box2D physics plugin'),
    new ExampleInfo('Box2d Car', 'box2dCar.js', 'Controllable vehicle using the Box2D physics plugin'),
    new ExampleInfo('Post Processing', 'postProcess.js', 'Post processing plugin demo'),
    new ExampleInfo('UI System Plugin', 'uiSystem.js', 'Simple example of LittleJS UI plugin'),
    new ExampleInfo('--- MINI GAMES ---'),
    new ExampleInfo('Platformer Game', 'platformer.js', 'Platformer jumping game'),
    new ExampleInfo('Top Down Game', 'topDown.js', 'Top down adventure game'),
    new ExampleInfo('Tilted View', 'tiltedView.js', 'Pseudo 3D view with tilted camera'),
    new ExampleInfo('Space Game', 'spaceGame.js', 'Space ship game with parallax starfield'),
    new ExampleInfo('Lander Game', 'landerGame.js', 'Lunar lander style game'),
    new ExampleInfo('Flappy Game', 'flappyGame.js', 'Flappy bird style game'),
    new ExampleInfo('Hill Glide Game', 'hillGlideGame.js', 'Tiny wings style game'),
    new ExampleInfo('Pong Game', 'pongGame.js', 'Simple pong style game'),
    new ExampleInfo('Sliding Puzzle', 'slidingPuzzle.js', 'Sliding tile puzzle game'),
    new ExampleInfo('Raycasting Game', 'raycasting.js', 'Pseudo 3D raycasting system'),
    new ExampleInfo('--- FULL EXAMPLES ---'),
    new ExampleInfo('Starter', 'starter', 'Clean starter project', true),
    new ExampleInfo('Breakout Tutorial', 'breakoutTutorial', 'Tutorial Breakout example', true),
    new ExampleInfo('Breakout Game', 'breakout', 'Block breaking game with post-processing effects', true),
    new ExampleInfo('Platforming Game', 'platformer', 'Platformer/shooter with level data loading', true),
    new ExampleInfo('Puzzle Game', 'puzzle', 'Match 3 puzzle game with HD rendering', true),
    new ExampleInfo('Stress Test', 'stress', 'Max sprite/object test and music system demo', true),
    new ExampleInfo('Box2D Plugin', 'box2d', 'Demo of the Box2D physics plugin', true),
    new ExampleInfo('HTML Menus', 'htmlMenu', 'Shows how to combine HTML with LittleJS', true),
    new ExampleInfo('UI System Plugin', 'uiSystem', 'How to use LittleJS UI plugin', true),
    // Add more examples here!
];

///////////////////////////////////////////////////////////////////////////////

let iframeExample, inputTimeout, codeMirror;

// load the examples into the list
filterExamples();

// set the selected example from the URL hash
const selectedExample = location.hash.split`#`[1] || '';
let exampleIndex = exampleList.findIndex((example) => example.filename == selectedExample);
if (exampleIndex < 0)
    exampleIndex = 1;
selectExample.selectedIndex = exampleIndex;
setExample();

onresize = () =>
{
    // resize iframe to fit half the window
    const aspect = 1920 / 1080;
    let w = innerWidth / 2 | 0;
    let h = w / aspect | 0;
    iframeContainer.style.width = w + 'px';
    iframeContainer.style.height = h + 'px';
}
onresize();

///////////////////////////////////////////////////////////////////////////////

function filterExamples(reset=0)
{
    if (reset)
        inputSearch.value = '';
    
    // clear current options
    selectExample.options.length = 0;
    
    // filter and add matching examples
    const searchTerm = inputSearch.value.toLowerCase().trim();
    for (let i = 0; i < exampleList.length; i++)
    {
        // check if search term matches name or description
        const example = exampleList[i];
        const text = example.name + (example.description ? ` - ${example.description}` : '');
        if (example.name.toLowerCase().includes(searchTerm) || 
            example.description.toLowerCase().includes(searchTerm))
        {
            const o = new Option(text);
            o.disabled = !example.filename;
            o.originalIndex = i;
            selectExample.add(o);
        }
    }
    
    if (!selectExample.options.length)
    {
        // show a message if no matches
        const o = new Option('No examples found matching "' + searchTerm + '"');
        o.disabled = true;
        selectExample.add(o);
    }
}

function setExample()
{
    // get the original index if this is a filtered result
    const selectedOption = selectExample.options[selectExample.selectedIndex];
    let exampleIndex = selectedOption && selectedOption.originalIndex ? 
        parseInt(selectedOption.originalIndex) : 
        selectExample.selectedIndex;
    
    // make sure we have a valid example
    if (exampleIndex < 0 || exampleIndex >= exampleList.length)
        exampleIndex = 1;  // reset to default
    if (!exampleList[exampleIndex].filename)
        exampleIndex = 1;
    
    // load the example
    const example = exampleList[exampleIndex];
    exampleInfo.innerText = example.name + (example.description ? ' - ' + example.description : '');
    const filename = 'examples/' + example.filename;
    exampleLink.href = 'https://github.com/KilledByAPixel/LittleJS/tree/main/' + filename;
    exampleLink.innerText = filename;
    location.hash = example.filename;
    loadFile(example.filename, example.largeExample);
}

function codeInput()
{
    if (!checkboxLiveEdit.checked)
        return;

    // debounce input - get content from code mirror if available, otherwise from textarea
    clearTimeout(inputTimeout);
    const code = codeMirror ? codeMirror.getValue() : textareaCode.value;
    inputTimeout = setTimeout(() => setCode(code), 500);
}

async function loadFile(filename, largeExample)
{
    if (codeMirror)
        codeMirror.setOption('readOnly', largeExample);
    else
        textareaCode.disabled = largeExample;
    
    if (largeExample)
    {
        if (iframeExample)
            iframeContainer.removeChild(iframeExample);

        unsetErrorMessage();
        iframeExample = document.createElement('iframe');
        iframeContainer.appendChild(iframeExample);
        
        // Show message in code view that full examples can't be edited
        const message = 'Code view not available for large examples.';
        if (codeMirror)
        {
            codeMirror.off('change', codeInput);
            codeMirror.setOption('mode', 'text');
            codeMirror.setValue(message);
        }
        else
            textareaCode.value = message;
        clearTimeout(inputTimeout);
        iframeExample.src = filename;
        return;
    }

    try
    {
        const response = await fetch(filename);
        if (!response.ok)
            throw new Error('Could not load file: ' + filename);
        const text = await response.text();
        
        // set the code in both code mirror and textarea
        if (codeMirror)
        {
            codeMirror.on('change', codeInput);
            codeMirror.setOption('mode', 'javascript');
            codeMirror.setValue(text);
        }
        else
            textareaCode.value = text;
        clearTimeout(inputTimeout);
        setCode(text);
    }
    catch (error)
    {
        setErrorMessage(error.message);
    }
}

function setCode(code)
{
    clearTimeout(inputTimeout);
    if (iframeExample)
        iframeContainer.removeChild(iframeExample);

    unsetErrorMessage();
    iframeExample = document.createElement('iframe');
    iframeContainer.appendChild(iframeExample);
    iframeExample.onload = () =>
    {
        const iframeContent = iframeExample.contentWindow;
        const iframeDocument = iframeContent.document;

        // create error event listeners
        iframeContent.onerror = (message, source, lineno, colno, error) =>
        {
            let text = message;
            if (lineno)  
                text += ` (Line:${lineno}, Column:${colno})`
            if (error && error.stack)
                text += `\n\n` + error.stack;
            setErrorMessage(text);
        }
        iframeContent.onunhandledrejection = (event) => 
        {
            let text = event.reason;
            if (event.reason && event.reason.stack)
                text += `\n\n` + event.reason.stack;
            setErrorMessage(text);
        };
        iframeContent.console.assert = function (condition, output)
        {
            // route asserts to our error handler
            if (!condition)
                throw 'Assertion failed!\n' + (output || '') + '\n' + (new Error).stack;
        };

        // create a script element that overrides the default functions
        const overrideScript = iframeDocument.createElement('script');
        iframeDocument.body.appendChild(overrideScript);
        overrideScript.text = code;
        
        if (textareaError.style.display == 'block')
            return; // stop if script error
        
        // start LittleJS engine
        iframeContent.engineInit(iframeContent.gameInit, iframeContent.gameUpdate, iframeContent.gameUpdatePost, iframeContent.gameRender, iframeContent.gameRenderPost, ['tiles.png?1']);

        buttonScreenshot.onclick = () =>
        {
            if (iframeContent.debugScreenshot)
                iframeContent.debugScreenshot();
        }
    }
    iframeExample.src = 'shorts/base.html';
}

function unsetErrorMessage()
{
    textareaError.style.display = 'none';
}

function setErrorMessage(message)
{
    if (message === null)
        message = 'null';
    if (Number.isNaN(message))
        message = 'NaN';
    if (message === undefined)
        message = 'undefined';
    textareaError.value = message;
    textareaError.style.display = message ? 'block' : 'none';
}

///////////////////////////////////////////////////////////////////////////////
// setup code mirror

const defaultTheme = 'monokai';
const defaultFontSize = '16px';
const themes = 
[
    'littlejs',
    '3024-night',
    'abcdef',
    'ambiance',
    'blackboard',
    'monokai',
    'duotone-light',
    'icecoder',
    'lesser-dark',
    'night',
    'yonce'
];

// Load saved preferences from localStorage
const savedTheme = localStorage.getItem('littleJS-theme') || defaultTheme;
const savedFontSize = localStorage.getItem('littleJS-fontSize') || defaultFontSize;

for (const theme of themes)
{
    if (theme != 'littlejs')
        addCodeMirrorElement(`theme/${theme}.min.css`, 'link', 'stylesheet');
    const o = new Option(theme);
    o.selected = theme == savedTheme;
    selectTheme.add(o);
}

// Set the saved font size
selectFontSize.value = savedFontSize;
textareaCode.style.fontSize = savedFontSize;
addCodeMirrorElement('codemirror.min.css', 'link', 'stylesheet');
addCodeMirrorElement('codemirror.min.js', 'script').onload = ()=>
addCodeMirrorElement('addon/edit/matchbrackets.js', 'script').onload = ()=> 
addCodeMirrorElement('mode/javascript/javascript.min.js', 'script').onload = ()=> 
initCodeMirror();

function initCodeMirror()
{
    const textareaCode = document.getElementById('textareaCode');
    codeMirror = CodeMirror.fromTextArea(textareaCode, 
    {
        theme: savedTheme,
        indentUnit: 4,
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
    });
    
    // make code mirror extend to the full height
    codeMirror.getWrapperElement().style.flexGrow = '1';
    loadTheme();
}

function addCodeMirrorElement(filename, type, rel) 
{
    // add element for code mirror
    const e = document.createElement(type);
    e.rel = rel;
    filename = 'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/' + filename;
    if (type == 'link')
        e.href = filename;
    else
        e.src = filename;
    e.crossOrigin = 'anonymous';
    document.head.appendChild(e);
    return e;
}

function loadTheme()
{
    const theme = selectTheme.value;
    const size = selectFontSize.value;
    
    // Save preferences to localStorage
    localStorage.setItem('littleJSExamples_theme', theme);
    localStorage.setItem('littleJSExamples_fontSize', size);
    
    // Apply the theme and font size
    textareaCode.style.fontSize = size;
    if (codeMirror)
    {
        codeMirror.getWrapperElement().style.fontSize = size;
        codeMirror.setOption('theme', theme);
    }
}

</script>
<style>
/*  LittleJS CodeMirror Theme */
.cm-s-littlejs.CodeMirror { background: #000; color: #fff; }
.cm-s-littlejs div.CodeMirror-selected { background: #068; }
.cm-s-littlejs .CodeMirror-gutters {background: #111; border-right: 0px;}
.cm-s-littlejs .CodeMirror-linenumber { color: #aaa; }
.cm-s-littlejs .CodeMirror-cursor { border-left: 2px solid #fff; }
.cm-s-littlejs .cm-keyword { color: #6e1; }
.cm-s-littlejs .cm-def { color: #fab; }
.cm-s-littlejs .cm-operator { color: #1be; }
.cm-s-littlejs .cm-property,
.cm-s-littlejs span.cm-variable { color: #ddd; font-style: italic; }
.cm-s-littlejs span.cm-variable-2 { color: #ea1; font-style: italic; }
.cm-s-littlejs span.cm-variable-3 { color: #aef; }
.cm-s-littlejs .cm-builtin,
.cm-s-littlejs .cm-number { color: #e15; }
.cm-s-littlejs .cm-comment { color:#777; font-style:italic; }
.cm-s-littlejs .cm-string { color:#fda; }
.cm-s-littlejs .cm-string-2 { color:#ea1; } 
.cm-s-littlejs .cm-error { border-bottom: 1px solid #f00; }
.cm-s-littlejs .CodeMirror-matchingbracket { color:#f0f !important; }
</style>
</body>
</html>
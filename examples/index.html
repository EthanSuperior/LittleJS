<!DOCTYPE html><head>
<title>LittleJS Example Browser</title>
<link rel=icon type=image/png href=favicon.png>
<link rel=stylesheet href=style.css?1>
<meta charset=utf-8>
</head><body>
<div id=container1>
<div id=container3>
<p id=titleInfo>LittleJS Example Browser</p>
<p id=exampleInfo></p>
<a id=exampleLink target='_blank'></a>
<hr>
<div>
Theme:
<select style=width:120px onchange=loadTheme() id=selectTheme></select>
<select style=width:40px onchange=loadTheme() id=selectFontSize>
    <option value=10px>XS</option>
    <option value=13px>S</option>
    <option value=16px selected>M</option>
    <option value=20px>L</option>
    <option value=24px>XL</option>
</select>
<input type=checkbox id=checkboxLiveEdit checked>Live Edit
<button id=buttonRefresh onclick="refreshCode()">Refresh</button>
</div> 
<textarea id=textareaCode oninput=codeInput() spellcheck=false></textarea>
<textarea id=textareaError readonly spellcheck=false></textarea>
<textarea id=textareaConsole readonly spellcheck=false></textarea>
</div>
<div id=container2>
<div id=iframeContainer></div>
<div>
<input id=inputSearch placeholder='Search examples...' oninput=filterExamples() onkeydown='if(event.key=="Escape")filterExamples(1)'> 
<button onclick=filterExamples(1)>Clear</button>
<button id=buttonPause>Pause</button>
<button id=buttonScreenshot>Screenshot</button>
</div>
<select id=selectExample autofocus onchange=setExample() size=2></select>
</div>
</div>
<script>
'use strict';

class ExampleInfo
{
    constructor(name, filename, description='', largeExample=false)
    {
        if (filename && !largeExample)
            filename = 'shorts/' + filename;
        this.name = name;
        this.filename = filename;
        this.description = description;
        this.largeExample = largeExample;
    }
}

const exampleList = 
[
    new ExampleInfo('--- SHORT EXAMPLES ---'),
    new ExampleInfo('Hello World', 'helloWorld.js', 'Simplest example'),
    new ExampleInfo('Shapes', 'shapes.js', 'How to draw geometric shapes'),
    new ExampleInfo('Colors', 'colors.js', 'How to use the color object'),
    new ExampleInfo('Blending', 'blending.js', 'How to use blending modes'),
    new ExampleInfo('Timers', 'timers.js', 'How to use the timer object'),
    new ExampleInfo('Texture', 'texture.js', 'How to display a full texture'),
    new ExampleInfo('Particles', 'particles.js', 'How to use the particle system'),
    new ExampleInfo('Play Sound', 'playSound.js', 'How to play sounds with zzfx'),
    new ExampleInfo('System Font', 'systemFont.js', 'Demo of the included system font'),
    new ExampleInfo('Sprite Atlas', 'spriteAtlas.js', 'How to set up a simple sprite atlas'),
    new ExampleInfo('Animation', 'animation.js', 'How to animate sprites'),
    new ExampleInfo('Clock', 'clock.js', 'Simple clock showing the time'),
    new ExampleInfo('Tile Layer', 'tileLayer.js', 'How to use the tile layer object'),
    new ExampleInfo('Piano', 'piano.js', 'A simple piano keyboard demo'),
    new ExampleInfo('Maze Generator', 'maze.js', 'Generates a random maze'),
    new ExampleInfo('Starfield', 'starfield.js', 'A moving starfield effect'),
    new ExampleInfo('Medals', 'medals.js', 'How to use the medal system'),
    new ExampleInfo('--- MINI GAMES ---'),
    new ExampleInfo('Platformer Game', 'platformer.js', 'Platformer jumping game'),
    new ExampleInfo('Top Down Game', 'topDown.js', 'Top down adventure game'),
    new ExampleInfo('Tilted View', 'tiltedView.js', 'Pseudo 3D view with tilted camera'),
    new ExampleInfo('Space Game', 'spaceGame.js', 'Space ship game with parallax starfield'),
    new ExampleInfo('Lander Game', 'landerGame.js', 'Lunar lander style game'),
    new ExampleInfo('Flappy Game', 'flappyGame.js', 'Flappy bird style game'),
    new ExampleInfo('Hill Glide Game', 'hillGlideGame.js', 'Tiny wings style game'),
    new ExampleInfo('Pong Game', 'pongGame.js', 'Simple pong style game'),
    new ExampleInfo('Sliding Puzzle', 'slidingPuzzle.js', 'Sliding tile puzzle game'),
    new ExampleInfo('Raycasting Game', 'raycasting.js', 'Pseudo 3D raycasting system'),
    new ExampleInfo('--- PLUGINS ---'),
    new ExampleInfo('Box2d Demo', 'box2d.js', 'Demo of the Box2D physics plugin'),
    new ExampleInfo('Box2d Car', 'box2dCar.js', 'Controllable vehicle using the Box2D physics plugin'),
    new ExampleInfo('Post Processing', 'postProcess.js', 'Post processing plugin demo'),
    new ExampleInfo('UI System Plugin', 'uiSystem.js', 'Simple example of LittleJS UI plugin'),
    new ExampleInfo('Nine Slice', 'nineSlice.js', 'Demo of nine slice and three slice drawing'),
    new ExampleInfo('--- FULL EXAMPLES ---'),
    new ExampleInfo('Starter', 'starter', 'Clean starter project', true),
    new ExampleInfo('Breakout Tutorial', 'breakoutTutorial', 'Tutorial Breakout example', true),
    new ExampleInfo('Breakout Game', 'breakout', 'Block breaking game with post-processing effects', true),
    new ExampleInfo('Platforming Game', 'platformer', 'Platformer/shooter with level data loading', true),
    new ExampleInfo('Puzzle Game', 'puzzle', 'Match 3 puzzle game with HD rendering', true),
    new ExampleInfo('Stress Test', 'stress', 'Max sprite/object test and music system demo', true),
    new ExampleInfo('Box2D Plugin', 'box2d', 'Demo of the Box2D physics plugin', true),
    new ExampleInfo('HTML Menus', 'htmlMenu', 'Shows how to combine HTML with LittleJS', true),
    new ExampleInfo('UI System Plugin', 'uiSystem', 'How to use LittleJS UI plugin', true),
];

///////////////////////////////////////////////////////////////////////////////

let iframeExample, inputTimeout, codeMirror;

// load the examples into the list
filterExamples();

// set the selected example from the URL hash
const selectedExample = location.hash.split`#`[1] || '';
let exampleIndex = exampleList.findIndex((example) => example.filename == selectedExample);
if (exampleIndex < 0)
    exampleIndex = 1;
selectExample.selectedIndex = exampleIndex;
setExample();

onresize = () =>
{
    // resize iframe to fit half the window
    const aspect = 1920 / 1080;
    let w = innerWidth / 2 | 0;
    let h = w / aspect | 0;
    iframeContainer.style.width = w + 'px';
    iframeContainer.style.height = h + 'px';
    // fix code mirror width
    container3.style.width = w-30 + 'px';
}
onresize();

///////////////////////////////////////////////////////////////////////////////

function filterExamples(reset=0)
{
    if (reset)
        inputSearch.value = '';
    
    // clear current options
    selectExample.options.length = 0;
    
    // filter and add matching examples
    const searchTerm = inputSearch.value.toLowerCase().trim();
    for (let i = 0; i < exampleList.length; i++)
    {
        // check if search term matches name or description
        const example = exampleList[i];
        const text = example.name + (example.description ? ` - ${example.description}` : '');
        if (example.name.toLowerCase().includes(searchTerm) || 
            example.description.toLowerCase().includes(searchTerm))
        {
            const o = new Option(text);
            o.disabled = !example.filename;
            o.originalIndex = i;
            selectExample.add(o);
        }
    }
    
    if (!selectExample.options.length)
    {
        // show a message if no matches
        const o = new Option('No examples found matching "' + searchTerm + '"');
        o.disabled = true;
        selectExample.add(o);
    }
}

function setExample()
{
    // get the original index if this is a filtered result
    const selectedOption = selectExample.options[selectExample.selectedIndex];
    let exampleIndex = selectedOption && selectedOption.originalIndex ? 
        parseInt(selectedOption.originalIndex) : 
        selectExample.selectedIndex;
    
    // make sure we have a valid example
    if (exampleIndex < 0 || exampleIndex >= exampleList.length)
        exampleIndex = 1;  // reset to default
    if (!exampleList[exampleIndex].filename)
        exampleIndex = 1;
    
    // load the example
    const example = exampleList[exampleIndex];
    exampleInfo.innerText = example.name + (example.description ? ' - ' + example.description : '');
    const filename = 'examples/' + example.filename;
    exampleLink.href = 'https://github.com/KilledByAPixel/LittleJS/tree/main/' + filename;
    exampleLink.innerText = filename;
    location.hash = example.filename;
    loadFile(example.filename, example.largeExample);
}

function codeInput()
{
    if (!checkboxLiveEdit.checked)
        return;

    // debounce input - get content from code mirror if available, otherwise from textarea
    clearTimeout(inputTimeout);
    const code = codeMirror ? codeMirror.getValue() : textareaCode.value;
    inputTimeout = setTimeout(() => setCode(code), 500);
}

function refreshCode()
{
    // manually refresh/run the code regardless of live edit setting
    const code = codeMirror ? codeMirror.getValue() : textareaCode.value;
    setCode(code);
}

async function loadFile(filename, largeExample)
{
    if (codeMirror)
        codeMirror.setOption('readOnly', largeExample);
    else
        textareaCode.disabled = largeExample;
    
    if (largeExample)
    {
        if (iframeExample)
            iframeContainer.removeChild(iframeExample);

        unsetErrorMessage();
        iframeExample = document.createElement('iframe');
        iframeContainer.appendChild(iframeExample);
        
        // Show message in code view that full examples can't be edited
        const message = 'Code view not available for large examples.';
        if (codeMirror)
        {
            codeMirror.off('change', codeInput);
            codeMirror.setOption('mode', 'text');
            codeMirror.setValue(message);
        }
        else
            textareaCode.value = message;
        clearTimeout(inputTimeout);
        iframeExample.src = filename;
        return;
    }

    try
    {
        const response = await fetch(filename);
        if (!response.ok)
            throw new Error('Could not load file: ' + filename);
        const text = await response.text();
        
        // set the code in both code mirror and textarea
        if (codeMirror)
        {
            codeMirror.on('change', codeInput);
            codeMirror.setOption('mode', 'javascript');
            codeMirror.setValue(text);
        }
        else
            textareaCode.value = text;
        clearTimeout(inputTimeout);
        setCode(text);
    }
    catch (error)
    {
        setErrorMessage(error.message);
    }
}

function setCode(code)
{
    clearTimeout(inputTimeout);
    if (iframeExample)
        iframeContainer.removeChild(iframeExample);

    unsetErrorMessage();
    unsetConsoleMessage();
    iframeExample = document.createElement('iframe');
    iframeContainer.appendChild(iframeExample);
    iframeExample.onload = () =>
    {
        const iframeContent = iframeExample.contentWindow;
        const iframeDocument = iframeContent.document;

        // create error event listeners
        iframeContent.onerror = (message, source, lineno, colno, error) =>
        {
            let text = message;
            if (lineno)  
                text += ` (Line:${lineno}, Column:${colno})`
            if (error && error.stack)
                text += `\n\n` + error.stack;
            setErrorMessage(text);
        }
        iframeContent.onunhandledrejection = (event) => 
        {
            let text = event.reason;
            if (event.reason && event.reason.stack)
                text += `\n\n` + event.reason.stack;
            setErrorMessage(text);
        };

        // intercept console methods
        const originalConsole = iframeContent.console;
        function interceptConsole(method)
        {
            const original = originalConsole[method];
            iframeContent.console[method] = function(...args)
            {
                let message = args.join('\n');
                setConsoleMessage(message);
                original.apply(originalConsole, args);
            };
        }
        ['log','info','warn','error','debug'].forEach(f=>interceptConsole(f));

        // intercept asserts
        const originalAssert = iframeContent.console.assert;
        iframeContent.console.assert = function (condition, output)
        {
           if (!condition)
                setErrorMessage('Assertion failed!\n' + (output || '') + '\n' + (new Error).stack);
            originalAssert.apply(this, arguments);
        };

        // create a script element that overrides the default functions
        const overrideScript = iframeDocument.createElement('script');
        iframeDocument.body.appendChild(overrideScript);
        overrideScript.text = code;
        
        if (textareaError.style.display == 'block')
            return; // stop if script error
        
        // start LittleJS engine
        iframeContent.engineInit(iframeContent.gameInit, iframeContent.gameUpdate, iframeContent.gameUpdatePost, iframeContent.gameRender, iframeContent.gameRenderPost, ['tiles.png?'+Date.now()]);

        buttonScreenshot.onclick = () =>
        {
            if (iframeContent.debugScreenshot)
                iframeContent.debugScreenshot();
        }

        // pause/resume functionality
        buttonPause.onclick = () =>
        {
            if (!iframeContent.getPaused || !iframeContent.setPaused)
                return;
            
            const paused = !iframeContent.getPaused();
            iframeContent.setPaused(paused);
            buttonPause.textContent = paused ? 'Resume' : 'Pause';
        }
        buttonPause.textContent = 'Pause';
    }
    iframeExample.src = 'shorts/base.html?' + Date.now();
}

function unsetMessage(element)
{
    element.style.display = 'none';
    element.value = '';
}

function setMessage(message, element)
{
    if (message === null)
        message = 'null';
    if (Number.isNaN(message))
        message = 'NaN';
    if (message === undefined)
        message = 'undefined';
    element.value = message;
    element.style.display = message ? 'block' : 'none';
}

function unsetErrorMessage() { unsetMessage(textareaError); }
function setErrorMessage(message) { setMessage(message, textareaError); }
function unsetConsoleMessage() { unsetMessage(textareaConsole); }
function setConsoleMessage(message) { setMessage(message, textareaConsole); }

///////////////////////////////////////////////////////////////////////////////
// setup code mirror

const defaultTheme = 'littlejs';
const defaultFontSize = '16px';
const themes = 
[
    'littlejs',
    '3024-night',
    'abcdef',
    'ambiance',
    'blackboard',
    'monokai',
    'duotone-light',
    'icecoder',
    'lesser-dark',
    'night',
    'yonce'
];

// Load saved preferences from localStorage
const savedTheme = localStorage.getItem('littleJS-theme') || defaultTheme;
const savedFontSize = localStorage.getItem('littleJS-fontSize') || defaultFontSize;

for (const theme of themes)
{
    if (theme != 'littlejs')
        addCodeMirrorElement(`theme/${theme}.min.css`, 'link', 'stylesheet');
    const o = new Option(theme);
    o.selected = theme == savedTheme;
    selectTheme.add(o);
}

// Set the saved font size
selectFontSize.value = savedFontSize;
textareaCode.style.fontSize = savedFontSize;
addCodeMirrorElement('codemirror.min.css', 'link', 'stylesheet');
addCodeMirrorElement('codemirror.min.js', 'script').onload = ()=>
addCodeMirrorElement('addon/edit/matchbrackets.js', 'script').onload = ()=> 
addCodeMirrorElement('mode/javascript/javascript.min.js', 'script').onload = ()=> 
initCodeMirror();

function initCodeMirror()
{
    const textareaCode = document.getElementById('textareaCode');
    codeMirror = CodeMirror.fromTextArea(textareaCode, 
    {
        theme: savedTheme,
        indentUnit: 4,
        mode: 'javascript',
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
    });
    codeMirror.on('change', codeInput);
    loadTheme();
}

function addCodeMirrorElement(filename, type, rel) 
{
    // add element for code mirror
    const e = document.createElement(type);
    e.rel = rel;
    filename = 'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/' + filename;
    if (type == 'link')
        e.href = filename;
    else
        e.src = filename;
    e.crossOrigin = 'anonymous';
    document.head.appendChild(e);
    return e;
}

function loadTheme()
{
    const theme = selectTheme.value;
    const size = selectFontSize.value;
    
    // Save preferences to localStorage
    localStorage.setItem('littleJSExamples_theme', theme);
    localStorage.setItem('littleJSExamples_fontSize', size);
    
    // Apply the theme and font size
    textareaCode.style.fontSize = size;
    if (codeMirror)
    {
        codeMirror.getWrapperElement().style.fontSize = size;
        codeMirror.setOption('theme', theme);
    }
}

</script>
</body>
</html>